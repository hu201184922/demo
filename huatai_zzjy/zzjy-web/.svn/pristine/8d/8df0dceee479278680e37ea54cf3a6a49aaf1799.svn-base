package com.huatai.web.job;

import java.util.Date;
import java.util.List;

import org.quartz.JobExecutionContext;
import org.quartz.JobExecutionException;
import org.springframework.context.ApplicationContext;
import org.springframework.scheduling.quartz.QuartzJobBean;

import com.huatai.web.model.TriggleExecute;
import com.huatai.web.service.TriggleExecuteService;
import com.huatai.web.utils.RedisDataSwitch;

public class StartRedisJob extends QuartzJobBean {

	private ApplicationContext applicationContext;

	public void setApplicationContext(ApplicationContext applicationContext) {
		this.applicationContext = applicationContext;
	}

	@Override
	protected void executeInternal(JobExecutionContext context) throws JobExecutionException {
		Long groupId = 0L;
		String qrtzCode = "ClearRedisJob";
		TriggleExecuteService triggleExecuteService = applicationContext.getBean(TriggleExecuteService.class);
		List<TriggleExecute> teList = triggleExecuteService.findAll(groupId, qrtzCode, null, null);
		if (teList != null && teList.size() > 0)
			triggleExecuteService.deleteByPrimaryKey(groupId, qrtzCode);
		Date now = new Date();
		TriggleExecute teToday = new TriggleExecute();
		teToday.setQrtzGroupId(groupId);
		teToday.setQrtzCode(qrtzCode);
		teToday.setExecBeginTime(now);
		teToday.setExecEndTime(null);
		teToday.setExecStatus("0");
		triggleExecuteService.insert(teToday);
		// --------------
		RedisDataSwitch.startRedisData();
		// --------------
		teToday.setExecStatus("1");
		Date endTime = new Date();
		teToday.setExecEndTime(endTime);
		triggleExecuteService.updateByPrimaryKey(teToday);
	}

}
