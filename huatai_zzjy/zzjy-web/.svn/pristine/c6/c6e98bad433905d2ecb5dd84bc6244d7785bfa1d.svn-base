<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fairyland.jdp.framework.log.mapper.LogMapper"> 

	<select id="getLog" parameterType="Map" resultType="com.fairyland.jdp.framework.log.domain.LogBean">
		WITH WLOG AS(
	SELECT LOGIN_NAME, COUNT(DISTINCT JL.SESSION_ID) AS LOGINCOUNT,MAX(TIME) AS TIME
	  FROM JDP_LOG JL
	 WHERE LOGIN_NAME IS NOT NULL
	   AND LOGIN_NAME != 'null'
	   AND LOGIN_NAME != 'admin'
	   AND JL.SESSION_ID IS NOT NULL
	   <if test="beginDate != null">
	   		AND TO_CHAR(JL.TIME+0,'yyyy-MM-dd') <![CDATA[ >= ]]> #{beginDate}
	   </if>
	   <if test="endDate != null">
	   		AND TO_CHAR(JL.TIME+0,'yyyy-MM-dd') <![CDATA[ <= ]]> #{endDate}
	   </if>
	 GROUP BY LOGIN_NAME),
	 WCT AS (
	SELECT CT.ACCOUNT, MAX(CT.LOGINTIME) AS LOGINTIME
	  FROM CRM_TOKEN_TB CT
	 GROUP BY CT.ACCOUNT
	)
	SELECT S.LOGIN_NAME AS LOGINNAME,S.USERNAME,S.LOGINCOUNT,S.LASTLOGINTIME,S.ORGNAME,S.TIME AS LASTUPDATETIME,S.CHANNEL,COUNT(CP.PARTNERID) AS LACOMTOAGENTCOUNT,SUM(DECODE(CLTT.STATE,'Y',1,0)) AS COMPCOUNT FROM (
	 <![CDATA[
	SELECT W.LOGIN_NAME,
		   U.USERNAME, 
	       W.LOGINCOUNT,
	       CASE
	         WHEN U.LAST_LOGINED_TIME + 0 >=
	              NVL(WCT.LOGINTIME, TO_DATE('1900-01-01', 'yyyy-MM-dd')) THEN
	          U.LAST_LOGINED_TIME + 0
	         ELSE
	          WCT.LOGINTIME
	       END AS LASTLOGINTIME,
	       O.ORGNAME,
	       U.CHANNEL,
	       W.TIME
	  FROM WLOG W
	  LEFT JOIN JDP_USER U ON W.LOGIN_NAME = U.ACCOUNT
	  LEFT JOIN WCT ON W.LOGIN_NAME = WCT.ACCOUNT
	  LEFT JOIN JDP_ORGANIZATION O ON NVL(U.ORG_CODE,U.CITY)= O.ORGCODE
	]]>
	  WHERE 1=1
	<if test="isType != null">
		AND U.ISTYPE = #{isType}
	</if>
	) S LEFT JOIN COMP_LACOMTOAGENT_TI CLT ON  S.LOGIN_NAME=CLT.AGENTCODE AND LENGTH(TRIM(CLT.AGENTCOM))=14
	LEFT JOIN COMP_LACOM_TI CLTT ON CLT.AGENTCOM=CLTT.AGENTCOM
	LEFT JOIN CRM_PARTNER_TB CP ON CP.OWNER = S.LOGIN_NAME
	GROUP BY S.LOGIN_NAME,S.LOGINCOUNT,S.LASTLOGINTIME,S.ORGNAME,S.CHANNEL,S.TIME,S.USERNAME
	ORDER BY LASTLOGINTIME DESC
	</select>
	
	<select id="getRunLogQuery" parameterType="Map" resultType="com.fairyland.jdp.framework.log.domain.RunLogBean">
		SELECT T.DEAL_ACTION AS dealAction,
			T.DEAL_TAB AS dealTab,
			T.ID AS id,
			T.NAME AS name,
			T.OWNER AS owner,
			T.DEAL_TIME AS dealTime
		FROM
		CRM_COMP_RUN_LOG_TB T
		WHERE 1=1
		<if test="dealTab != null">
			AND T.DEAL_TAB = #{dealTab}
		</if>
		<if test="beginDate != null">
			AND T.DEAL_TIME <![CDATA[ >= ]]> TO_DATE(#{beginDate},'yyyy-mm-dd')
		</if>
		<if test="endDate != null">
			AND T.DEAL_TIME <![CDATA[ <= ]]> TO_DATE(#{endDate},'yyyy-mm-dd')
		</if>
		ORDER BY T.DEAL_TAB,T.DEAL_TIME DESC
	</select>
	
	<select id="getRunLogDealTab" resultType="String">
		SELECT DISTINCT(T.DEAL_TAB) FROM CRM_COMP_RUN_LOG_TB T
	</select>

</mapper>