package com.ehuatai.biz.index.service.impl;

import java.text.DecimalFormat;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import org.apache.thrift.TException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.ehuatai.biz.index.service.BoardRealService;
import com.ehuatai.biz.mapper.SQLMapper;
import com.ehuatai.biz.mapper.SszbMapper;
import com.ehuatai.ret.RestCode;
import com.ehuatai.ret.RestResult;
import com.ehuatai.thrift.DashbordService;
import com.ehuatai.thrift.ResponseBeanDto;
import com.ehuatai.thrift.DashbordService.Client;
import com.ehuatai.thrift.util.ThriftUtil;
import com.fairyland.jdp.orm.util.common.StringUtil;

@Service
public class BoardRealServiceImpl implements BoardRealService {

	private Logger log = LoggerFactory.getLogger(getClass());

	@Autowired
	private SQLMapper sqlMapper;
	@Autowired
	private SszbMapper ssMapper;

	private List<Map<String, Object>> list1 = new ArrayList<>();
	private List<Map<String, Object>> list2 = new ArrayList<>();
	private List<Map<String, Object>> list3 = new ArrayList<>();

	private Client getClient() {
		Client client = null;
		try {
			client = ThriftUtil.getService(DashbordService.Client.class);
		} catch (Exception e) {
			log.error(e.getMessage());
			e.printStackTrace();
		}
		return client;
	}

	public RestResult getDSBrealTime(Map<String, Object> reqParams) {
		//{username=10000066, role=3_100101_1, roleDept=100101, roleOrg=10403}
		Client client = this.getClient();
		if (client == null) {
			log.error(RestCode.THRIFT_CLIENT_ERROR.getErrMsg());
			return RestResult.getError(RestCode.THRIFT_CLIENT_ERROR);
		}
		ResponseBeanDto dto = null;
		JSONObject resultObj;
		try {
			String reqParamsJSON = JSON.toJSONString(reqParams);
			dto = client.getRealTimeTarget(reqParamsJSON);
			//ResponseBeanDto [errCode=200, errMsgs=, success=true, json={"unit":"万元","endTime":"2018-03-30 19:09","sql":{"MONTH":"WITH  ORG AS (    SELECT DISTINCT D.DEPT_NAME AS NAME, D.DEPT_ID AS CODE      FROM ODATA.OD_DEPT D INNER JOIN ODATA.OD_DEPT D1 ON D.DEPT_ID = D1.BUSI_DEPT_ID    WHERE D.STATUS ='1' AND D.DEPT_CATE='1' AND D.ORGAN_ID = '10403'   ), THISMONTH AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_M A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1    AND A.DATECODE = FROM_TIMESTAMP(NOW(), 'yyyy-MM')          GROUP BY  TEAMCOMNAME , TEAMCOMCODE  ), LASTYEARMONTH AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_M A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1    AND A.DATECODE = FROM_TIMESTAMP(ADD_MONTHS(NOW(),-24), 'yyyy-MM')          GROUP BY  TEAMCOMNAME , TEAMCOMCODE  ), THISMONTHTARGET AS (      {target_month_table} )  SELECT T.VAL0,T.VAL2,T.VAL3,T.VAL4 FROM ( SELECT   0 AS ID,   ORG.CODE,   ORG.NAME VAL0,   ROUND(NVL(THISMONTH.VAL,0)/10000.00,2) AS VAL2,   IF(NVL(THISMONTHTARGET.VAL,0)=0,'--', CAST(NVL(THISMONTH.VAL,0)/THISMONTHTARGET.VAL*100.00 AS VARCHAR) ) AS VAL3,   IF(NVL(LASTYEARMONTH.VAL,0)=0,'--', CAST((NVL(THISMONTH.VAL,0)/LASTYEARMONTH.VAL-1)*100.00 AS VARCHAR) ) AS VAL4 FROM ORG LEFT JOIN THISMONTH       ON ORG.CODE = THISMONTH.CODE LEFT JOIN LASTYEARMONTH   ON ORG.CODE = LASTYEARMONTH.CODE LEFT JOIN THISMONTHTARGET ON ORG.CODE = THISMONTHTARGET.CODE UNION ALL   SELECT   1 AS ID,   '999' AS CODE,   '合计' VAL0,   ROUND(NVL(SUM(THISMONTH.VAL),0)/10000.00,2) AS VAL2,   IF(NVL(SUM(THISMONTHTARGET.VAL),0)=0,'--', CAST(NVL(SUM(THISMONTH.VAL),0)/SUM(THISMONTHTARGET.VAL)*100.00 AS VARCHAR) ) AS VAL3,   IF(NVL(SUM(LASTYEARMONTH.VAL),0)=0,'--', CAST((NVL(SUM(THISMONTH.VAL),0)/SUM(LASTYEARMONTH.VAL)-1)*100.00 AS VARCHAR) ) AS VAL4 FROM ORG LEFT JOIN THISMONTH       ON ORG.CODE = THISMONTH.CODE LEFT JOIN LASTYEARMONTH   ON ORG.CODE = LASTYEARMONTH.CODE LEFT JOIN THISMONTHTARGET ON ORG.CODE = THISMONTHTARGET.CODE ) T ORDER BY ID,CODE","YEAR":"WITH  ORG AS (    SELECT DISTINCT D.DEPT_NAME AS NAME, D.DEPT_ID AS CODE      FROM ODATA.OD_DEPT D INNER JOIN ODATA.OD_DEPT D1 ON D.DEPT_ID = D1.BUSI_DEPT_ID    WHERE D.STATUS ='1' AND D.DEPT_CATE='1' AND D.ORGAN_ID = '10403'   ), THISYEAR AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_Y A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1    AND A.DATECODE = FROM_TIMESTAMP(NOW(), 'yyyy')          GROUP BY  TEAMCOMNAME , TEAMCOMCODE  ), LASTYEAR AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_Y A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1    AND A.DATECODE = FROM_TIMESTAMP(ADD_MONTHS(NOW(),-24), 'yyyy')          GROUP BY  TEAMCOMNAME , TEAMCOMCODE  ), THISYEARTARGET AS (      {target_year_table} )  SELECT T.VAL0,T.VAL5,T.VAL6,T.VAL7 FROM ( SELECT   0 AS ID,   ORG.CODE,   ORG.NAME VAL0,   ROUND(NVL(THISYEAR.VAL,0)/10000.00,2) AS VAL5,   IF(NVL(THISYEARTARGET.VAL,0)=0,'--', CAST(NVL(THISYEAR.VAL,0)/THISYEARTARGET.VAL*100.00 AS VARCHAR) ) AS VAL6,   IF(NVL(LASTYEAR.VAL,0)=0,'--', CAST((NVL(THISYEAR.VAL,0)/LASTYEAR.VAL-1)*100.00 AS VARCHAR) ) AS VAL7 FROM ORG LEFT JOIN THISYEAR        ON ORG.CODE = THISYEAR.CODE LEFT JOIN LASTYEAR        ON ORG.CODE = LASTYEAR.CODE LEFT JOIN THISYEARTARGET  ON ORG.CODE = THISYEARTARGET.CODE UNION ALL   SELECT   1 AS ID,   '999' AS CODE,   '合计' VAL0,   ROUND(NVL(SUM(THISYEAR.VAL),0)/10000.00,2) AS VAL5,   IF(NVL(SUM(THISYEARTARGET.VAL),0)=0,'--', CAST(NVL(SUM(THISYEAR.VAL),0)/SUM(THISYEARTARGET.VAL)*100.00 AS VARCHAR) ) AS VAL6,   IF(NVL(SUM(LASTYEAR.VAL),0)=0,'--', CAST((NVL(SUM(THISYEAR.VAL),0)/SUM(LASTYEAR.VAL)-1)*100.00 AS VARCHAR) ) AS VAL7 FROM ORG LEFT JOIN THISYEAR        ON ORG.CODE = THISYEAR.CODE LEFT JOIN LASTYEAR        ON ORG.CODE = LASTYEAR.CODE LEFT JOIN THISYEARTARGET  ON ORG.CODE = THISYEARTARGET.CODE ) T ORDER BY ID,CODE","DAY":"WITH  ORG AS (    SELECT DISTINCT D.DEPT_NAME AS NAME, D.DEPT_ID AS CODE      FROM ODATA.OD_DEPT D INNER JOIN ODATA.OD_DEPT D1 ON D.DEPT_ID = D1.BUSI_DEPT_ID    WHERE D.STATUS ='1' AND D.DEPT_CATE='1' AND D.ORGAN_ID = '10403'   ), THISDAY AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_D A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1     AND A.DATECODE =FROM_TIMESTAMP(NOW(), 'yyyy-MM-dd')            GROUP BY  TEAMCOMNAME , TEAMCOMCODE  )  SELECT T.VAL0,T.VAL1 FROM ( SELECT   0 AS ID,   ORG.CODE,   ORG.NAME VAL0,   ROUND(NVL(THISDAY.VAL,0)/10000.00,2) AS VAL1 FROM ORG LEFT JOIN THISDAY         ON ORG.CODE = THISDAY.CODE UNION ALL   SELECT   1 AS ID,   '999' AS CODE,   '合计' VAL0,   ROUND(NVL(SUM(THISDAY.VAL),0)/10000.00,2) AS VAL1 FROM THISDAY ) T ORDER BY ID,CODE"}}, timeStamp=2018-03-30 19:09:37]
			String resultJSONString = dto.getJson();
			//{"unit":"万元","endTime":"2018-03-30 19:09","sql":{"MONTH":"WITH  ORG AS (    SELECT DISTINCT D.DEPT_NAME AS NAME, D.DEPT_ID AS CODE      FROM ODATA.OD_DEPT D INNER JOIN ODATA.OD_DEPT D1 ON D.DEPT_ID = D1.BUSI_DEPT_ID    WHERE D.STATUS ='1' AND D.DEPT_CATE='1' AND D.ORGAN_ID = '10403'   ), THISMONTH AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_M A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1    AND A.DATECODE = FROM_TIMESTAMP(NOW(), 'yyyy-MM')          GROUP BY  TEAMCOMNAME , TEAMCOMCODE  ), LASTYEARMONTH AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_M A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1    AND A.DATECODE = FROM_TIMESTAMP(ADD_MONTHS(NOW(),-24), 'yyyy-MM')          GROUP BY  TEAMCOMNAME , TEAMCOMCODE  ), THISMONTHTARGET AS (      {target_month_table} )  SELECT T.VAL0,T.VAL2,T.VAL3,T.VAL4 FROM ( SELECT   0 AS ID,   ORG.CODE,   ORG.NAME VAL0,   ROUND(NVL(THISMONTH.VAL,0)/10000.00,2) AS VAL2,   IF(NVL(THISMONTHTARGET.VAL,0)=0,'--', CAST(NVL(THISMONTH.VAL,0)/THISMONTHTARGET.VAL*100.00 AS VARCHAR) ) AS VAL3,   IF(NVL(LASTYEARMONTH.VAL,0)=0,'--', CAST((NVL(THISMONTH.VAL,0)/LASTYEARMONTH.VAL-1)*100.00 AS VARCHAR) ) AS VAL4 FROM ORG LEFT JOIN THISMONTH       ON ORG.CODE = THISMONTH.CODE LEFT JOIN LASTYEARMONTH   ON ORG.CODE = LASTYEARMONTH.CODE LEFT JOIN THISMONTHTARGET ON ORG.CODE = THISMONTHTARGET.CODE UNION ALL   SELECT   1 AS ID,   '999' AS CODE,   '合计' VAL0,   ROUND(NVL(SUM(THISMONTH.VAL),0)/10000.00,2) AS VAL2,   IF(NVL(SUM(THISMONTHTARGET.VAL),0)=0,'--', CAST(NVL(SUM(THISMONTH.VAL),0)/SUM(THISMONTHTARGET.VAL)*100.00 AS VARCHAR) ) AS VAL3,   IF(NVL(SUM(LASTYEARMONTH.VAL),0)=0,'--', CAST((NVL(SUM(THISMONTH.VAL),0)/SUM(LASTYEARMONTH.VAL)-1)*100.00 AS VARCHAR) ) AS VAL4 FROM ORG LEFT JOIN THISMONTH       ON ORG.CODE = THISMONTH.CODE LEFT JOIN LASTYEARMONTH   ON ORG.CODE = LASTYEARMONTH.CODE LEFT JOIN THISMONTHTARGET ON ORG.CODE = THISMONTHTARGET.CODE ) T ORDER BY ID,CODE","YEAR":"WITH  ORG AS (    SELECT DISTINCT D.DEPT_NAME AS NAME, D.DEPT_ID AS CODE      FROM ODATA.OD_DEPT D INNER JOIN ODATA.OD_DEPT D1 ON D.DEPT_ID = D1.BUSI_DEPT_ID    WHERE D.STATUS ='1' AND D.DEPT_CATE='1' AND D.ORGAN_ID = '10403'   ), THISYEAR AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_Y A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1    AND A.DATECODE = FROM_TIMESTAMP(NOW(), 'yyyy')          GROUP BY  TEAMCOMNAME , TEAMCOMCODE  ), LASTYEAR AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_Y A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1    AND A.DATECODE = FROM_TIMESTAMP(ADD_MONTHS(NOW(),-24), 'yyyy')          GROUP BY  TEAMCOMNAME , TEAMCOMCODE  ), THISYEARTARGET AS (      {target_year_table} )  SELECT T.VAL0,T.VAL5,T.VAL6,T.VAL7 FROM ( SELECT   0 AS ID,   ORG.CODE,   ORG.NAME VAL0,   ROUND(NVL(THISYEAR.VAL,0)/10000.00,2) AS VAL5,   IF(NVL(THISYEARTARGET.VAL,0)=0,'--', CAST(NVL(THISYEAR.VAL,0)/THISYEARTARGET.VAL*100.00 AS VARCHAR) ) AS VAL6,   IF(NVL(LASTYEAR.VAL,0)=0,'--', CAST((NVL(THISYEAR.VAL,0)/LASTYEAR.VAL-1)*100.00 AS VARCHAR) ) AS VAL7 FROM ORG LEFT JOIN THISYEAR        ON ORG.CODE = THISYEAR.CODE LEFT JOIN LASTYEAR        ON ORG.CODE = LASTYEAR.CODE LEFT JOIN THISYEARTARGET  ON ORG.CODE = THISYEARTARGET.CODE UNION ALL   SELECT   1 AS ID,   '999' AS CODE,   '合计' VAL0,   ROUND(NVL(SUM(THISYEAR.VAL),0)/10000.00,2) AS VAL5,   IF(NVL(SUM(THISYEARTARGET.VAL),0)=0,'--', CAST(NVL(SUM(THISYEAR.VAL),0)/SUM(THISYEARTARGET.VAL)*100.00 AS VARCHAR) ) AS VAL6,   IF(NVL(SUM(LASTYEAR.VAL),0)=0,'--', CAST((NVL(SUM(THISYEAR.VAL),0)/SUM(LASTYEAR.VAL)-1)*100.00 AS VARCHAR) ) AS VAL7 FROM ORG LEFT JOIN THISYEAR        ON ORG.CODE = THISYEAR.CODE LEFT JOIN LASTYEAR        ON ORG.CODE = LASTYEAR.CODE LEFT JOIN THISYEARTARGET  ON ORG.CODE = THISYEARTARGET.CODE ) T ORDER BY ID,CODE","DAY":"WITH  ORG AS (    SELECT DISTINCT D.DEPT_NAME AS NAME, D.DEPT_ID AS CODE      FROM ODATA.OD_DEPT D INNER JOIN ODATA.OD_DEPT D1 ON D.DEPT_ID = D1.BUSI_DEPT_ID    WHERE D.STATUS ='1' AND D.DEPT_CATE='1' AND D.ORGAN_ID = '10403'   ), THISDAY AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_D A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1     AND A.DATECODE =FROM_TIMESTAMP(NOW(), 'yyyy-MM-dd')            GROUP BY  TEAMCOMNAME , TEAMCOMCODE  )  SELECT T.VAL0,T.VAL1 FROM ( SELECT   0 AS ID,   ORG.CODE,   ORG.NAME VAL0,   ROUND(NVL(THISDAY.VAL,0)/10000.00,2) AS VAL1 FROM ORG LEFT JOIN THISDAY         ON ORG.CODE = THISDAY.CODE UNION ALL   SELECT   1 AS ID,   '999' AS CODE,   '合计' VAL0,   ROUND(NVL(SUM(THISDAY.VAL),0)/10000.00,2) AS VAL1 FROM THISDAY ) T ORDER BY ID,CODE"}}
			resultObj = JSONObject.parseObject(resultJSONString);
			JSONObject sqlObj = resultObj.getJSONObject("sql");
			//{"MONTH":"WITH  ORG AS (    SELECT DISTINCT D.DEPT_NAME AS NAME, D.DEPT_ID AS CODE      FROM ODATA.OD_DEPT D INNER JOIN ODATA.OD_DEPT D1 ON D.DEPT_ID = D1.BUSI_DEPT_ID    WHERE D.STATUS ='1' AND D.DEPT_CATE='1' AND D.ORGAN_ID = '10403'   ), THISMONTH AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_M A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1    AND A.DATECODE = FROM_TIMESTAMP(NOW(), 'yyyy-MM')          GROUP BY  TEAMCOMNAME , TEAMCOMCODE  ), LASTYEARMONTH AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_M A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1    AND A.DATECODE = FROM_TIMESTAMP(ADD_MONTHS(NOW(),-24), 'yyyy-MM')          GROUP BY  TEAMCOMNAME , TEAMCOMCODE  ), THISMONTHTARGET AS (      {target_month_table} )  SELECT T.VAL0,T.VAL2,T.VAL3,T.VAL4 FROM ( SELECT   0 AS ID,   ORG.CODE,   ORG.NAME VAL0,   ROUND(NVL(THISMONTH.VAL,0)/10000.00,2) AS VAL2,   IF(NVL(THISMONTHTARGET.VAL,0)=0,'--', CAST(NVL(THISMONTH.VAL,0)/THISMONTHTARGET.VAL*100.00 AS VARCHAR) ) AS VAL3,   IF(NVL(LASTYEARMONTH.VAL,0)=0,'--', CAST((NVL(THISMONTH.VAL,0)/LASTYEARMONTH.VAL-1)*100.00 AS VARCHAR) ) AS VAL4 FROM ORG LEFT JOIN THISMONTH       ON ORG.CODE = THISMONTH.CODE LEFT JOIN LASTYEARMONTH   ON ORG.CODE = LASTYEARMONTH.CODE LEFT JOIN THISMONTHTARGET ON ORG.CODE = THISMONTHTARGET.CODE UNION ALL   SELECT   1 AS ID,   '999' AS CODE,   '合计' VAL0,   ROUND(NVL(SUM(THISMONTH.VAL),0)/10000.00,2) AS VAL2,   IF(NVL(SUM(THISMONTHTARGET.VAL),0)=0,'--', CAST(NVL(SUM(THISMONTH.VAL),0)/SUM(THISMONTHTARGET.VAL)*100.00 AS VARCHAR) ) AS VAL3,   IF(NVL(SUM(LASTYEARMONTH.VAL),0)=0,'--', CAST((NVL(SUM(THISMONTH.VAL),0)/SUM(LASTYEARMONTH.VAL)-1)*100.00 AS VARCHAR) ) AS VAL4 FROM ORG LEFT JOIN THISMONTH       ON ORG.CODE = THISMONTH.CODE LEFT JOIN LASTYEARMONTH   ON ORG.CODE = LASTYEARMONTH.CODE LEFT JOIN THISMONTHTARGET ON ORG.CODE = THISMONTHTARGET.CODE ) T ORDER BY ID,CODE","YEAR":"WITH  ORG AS (    SELECT DISTINCT D.DEPT_NAME AS NAME, D.DEPT_ID AS CODE      FROM ODATA.OD_DEPT D INNER JOIN ODATA.OD_DEPT D1 ON D.DEPT_ID = D1.BUSI_DEPT_ID    WHERE D.STATUS ='1' AND D.DEPT_CATE='1' AND D.ORGAN_ID = '10403'   ), THISYEAR AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_Y A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1    AND A.DATECODE = FROM_TIMESTAMP(NOW(), 'yyyy')          GROUP BY  TEAMCOMNAME , TEAMCOMCODE  ), LASTYEAR AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_Y A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1    AND A.DATECODE = FROM_TIMESTAMP(ADD_MONTHS(NOW(),-24), 'yyyy')          GROUP BY  TEAMCOMNAME , TEAMCOMCODE  ), THISYEARTARGET AS (      {target_year_table} )  SELECT T.VAL0,T.VAL5,T.VAL6,T.VAL7 FROM ( SELECT   0 AS ID,   ORG.CODE,   ORG.NAME VAL0,   ROUND(NVL(THISYEAR.VAL,0)/10000.00,2) AS VAL5,   IF(NVL(THISYEARTARGET.VAL,0)=0,'--', CAST(NVL(THISYEAR.VAL,0)/THISYEARTARGET.VAL*100.00 AS VARCHAR) ) AS VAL6,   IF(NVL(LASTYEAR.VAL,0)=0,'--', CAST((NVL(THISYEAR.VAL,0)/LASTYEAR.VAL-1)*100.00 AS VARCHAR) ) AS VAL7 FROM ORG LEFT JOIN THISYEAR        ON ORG.CODE = THISYEAR.CODE LEFT JOIN LASTYEAR        ON ORG.CODE = LASTYEAR.CODE LEFT JOIN THISYEARTARGET  ON ORG.CODE = THISYEARTARGET.CODE UNION ALL   SELECT   1 AS ID,   '999' AS CODE,   '合计' VAL0,   ROUND(NVL(SUM(THISYEAR.VAL),0)/10000.00,2) AS VAL5,   IF(NVL(SUM(THISYEARTARGET.VAL),0)=0,'--', CAST(NVL(SUM(THISYEAR.VAL),0)/SUM(THISYEARTARGET.VAL)*100.00 AS VARCHAR) ) AS VAL6,   IF(NVL(SUM(LASTYEAR.VAL),0)=0,'--', CAST((NVL(SUM(THISYEAR.VAL),0)/SUM(LASTYEAR.VAL)-1)*100.00 AS VARCHAR) ) AS VAL7 FROM ORG LEFT JOIN THISYEAR        ON ORG.CODE = THISYEAR.CODE LEFT JOIN LASTYEAR        ON ORG.CODE = LASTYEAR.CODE LEFT JOIN THISYEARTARGET  ON ORG.CODE = THISYEARTARGET.CODE ) T ORDER BY ID,CODE","DAY":"WITH  ORG AS (    SELECT DISTINCT D.DEPT_NAME AS NAME, D.DEPT_ID AS CODE      FROM ODATA.OD_DEPT D INNER JOIN ODATA.OD_DEPT D1 ON D.DEPT_ID = D1.BUSI_DEPT_ID    WHERE D.STATUS ='1' AND D.DEPT_CATE='1' AND D.ORGAN_ID = '10403'   ), THISDAY AS (   SELECT       TEAMCOMNAME  AS NAME,     TEAMCOMCODE  AS CODE,    NVL(SUM(CAST(A.INSD_STD_PREM AS DECIMAL(20,6))),0) VAL    FROM DMA.DMA_RT_INDEX_D A     LEFT JOIN (SELECT DISTINCT TEAMCOMNAME,TEAMCOMCODE,AGENTGROUPCODE FROM PDATA.PD_DEPT_TMP) D ON A.AGENTGROUPCODE = D.AGENTGROUPCODE     WHERE 1=1     AND A.DATECODE =FROM_TIMESTAMP(NOW(), 'yyyy-MM-dd')            GROUP BY  TEAMCOMNAME , TEAMCOMCODE  )  SELECT T.VAL0,T.VAL1 FROM ( SELECT   0 AS ID,   ORG.CODE,   ORG.NAME VAL0,   ROUND(NVL(THISDAY.VAL,0)/10000.00,2) AS VAL1 FROM ORG LEFT JOIN THISDAY         ON ORG.CODE = THISDAY.CODE UNION ALL   SELECT   1 AS ID,   '999' AS CODE,   '合计' VAL0,   ROUND(NVL(SUM(THISDAY.VAL),0)/10000.00,2) AS VAL1 FROM THISDAY ) T ORDER BY ID,CODE"}
			String org = reqParams.get("roleOrg").toString();
			//org = 10403  机构
			ExecutorService exe = Executors.newFixedThreadPool(8);

			exe.execute(new Runnable() {

				@Override
				public void run() {
					String sqlDay = sqlObj.getString("DAY");
					if (sqlDay.contains("{target_month_table}")) {
						sqlDay = getSqlString(sqlDay, "YYYY-MM", org);
					}
					if (sqlDay.contains("{target_year_table}")) {
						sqlDay = getSqlString(sqlDay, "YYYY", org);
					}
					list1 = sqlMapper.findBySQL(sqlDay);
				}
			});
			exe.execute(new Runnable() {

				@Override
				public void run() {
					String sqlMon = sqlObj.getString("MONTH");
					if (sqlMon.contains("{target_month_table}")) {
						sqlMon = getSqlString(sqlMon, "YYYY-MM", org);
					}
					if (sqlMon.contains("{target_year_table}")) {
						sqlMon = getSqlString(sqlMon, "YYYY", org);
					}
					list2 = sqlMapper.findBySQL(sqlMon);
				}
			});
			exe.execute(new Runnable() {

				@Override
				public void run() {
					String sqlYear = sqlObj.getString("YEAR");
					if (sqlYear.contains("{target_month_table}")) {
						sqlYear = getSqlString(sqlYear, "YYYY-MM", org);
					}
					if (sqlYear.contains("{target_year_table}")) {
						sqlYear = getSqlString(sqlYear, "YYYY", org);
					}
					list3 = sqlMapper.findBySQL(sqlYear);
				}
			});
			exe.shutdown();
			Map<String, Object> targets = new HashMap<>();
			List<List<String>> days = new ArrayList<>();
			List<List<String>> months = new ArrayList<>();
			List<List<String>> years = new ArrayList<>();
			while (true) {
				if (exe.isTerminated()) {
					DecimalFormat df=new DecimalFormat("#.##");
					//[{val1=2.61, val0=常州市区}, {val1=0.98, val0=溧阳}, {val1=0.17, val0=武进}, 
					//{val1=2.24, val0=金坛}, {val1=21.98, val0=新北}, {val1=598.43, val0=合计}]
					for (Map<String, Object> lista : list1) {
						List<String> day = new ArrayList<>();
						String val0 = lista.get("val0").toString();
						//常州市区
						String val1 = lista.get("val1").toString();
						//2.61
						day.add(val0);
						day.add("--".equals(val1)?"--":String.valueOf(df.format(Double.parseDouble(val1))));
						days.add(day);
					}
					for (Map<String, Object> listb : list2) {
						List<String> month = new ArrayList<>();
						String val0 = listb.get("val0").toString();
						String val2 = listb.get("val2").toString();
						String val3 = listb.get("val3").toString();
						String val4 = listb.get("val4").toString();
						month.add(val0);
						month.add("--".equals(val2)?"--":String.valueOf(df.format(Double.parseDouble(val2))));
						month.add("--".equals(val3)?"--":String.valueOf(df.format(Double.parseDouble(val3))));
						month.add("--".equals(val4)?"--":String.valueOf(df.format(Double.parseDouble(val4))));
						months.add(month);
					}
					for (Map<String, Object> listc : list3) {
						List<String> year = new ArrayList<>();
						String val0 = listc.get("val0").toString();
						String val5 = listc.get("val5").toString();
						String val6 = listc.get("val6").toString();
						String val7 = listc.get("val7").toString();
						year.add(val0);
						year.add("--".equals(val5)?"--":String.valueOf(df.format(Double.parseDouble(val5))));
						year.add("--".equals(val6)?"--":String.valueOf(df.format(Double.parseDouble(val6))));
						year.add("--".equals(val7)?"--":String.valueOf(df.format(Double.parseDouble(val7))));
						years.add(year);
					}
					break;
				}
			}
			targets.put("day", days);
			targets.put("month", months);
			targets.put("year", years);
			resultObj.remove("sql");
			resultObj.put("targets", targets);
		} catch (TException e) {
			e.printStackTrace();
			return RestResult.getError(RestCode.THRIFT_CLIENT_UNKNOW_RESULT);
		} finally {
			ThriftUtil.close(client);
		}
		String resultJSONString = dto.getJson();
		if (StringUtils.isEmpty(resultJSONString)) {
			log.warn("结果为空");
			return RestResult.getError(RestCode.EMPTY);
		}
		return RestResult.getSuccess(resultObj);
	}

	// 替换过的SQL
	public String getSqlString(String sql, String dateStr, String org) {
		HashMap<String, Object> paramMap = new HashMap<>();
		paramMap.put("partten", dateStr);
		paramMap.put("org", org);
		List<Map<String, Object>> resOras = new ArrayList<>();
		switch (org.length()) {
		case 1:
			resOras = ssMapper.findPurZongByOra(paramMap);
			break;
		case 3:
			resOras = ssMapper.findPurFenByOra(paramMap);
			break;
		case 5:
			resOras = ssMapper.findPurZhiByOra(paramMap);
			break;
		}
		String target_table = getOraString(resOras);
		if ("YYYY-MM".equals(dateStr)) {
			sql = sql.replace("{target_month_table}", target_table);
		} else {
			sql = sql.replace("{target_year_table}", target_table);
		}
		return sql;
	}

	// 替换字符串
	public static String getOraString(List<Map<String, Object>> resOras) {
		String target_table = " SELECT '1' CODE,0 AS VAL ";
		if (!resOras.isEmpty() && StringUtil.isNotNull(resOras)) {
			target_table = " SELECT * FROM ( ";
			for (int i = 0; i < resOras.size(); i++) {
				if (i == 0) {
					target_table += " SELECT '" + resOras.get(0).get("CODE").toString() + "' CODE , "
							+ resOras.get(0).get("VAL").toString() + " AS VAL ";
				} else {
					target_table += " UNION ALL SELECT '" + resOras.get(i).get("CODE").toString() + "' CODE , "
							+ resOras.get(i).get("VAL").toString() + " AS VAL ";
				}
			}
			target_table += " ) X ";
		}
		return target_table;
	}
}
